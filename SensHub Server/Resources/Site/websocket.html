<!DOCTYPE html>
<html>
  <head>
    <title>WebSocket Test</title>
    <link type="text/css" rel="stylesheet" href="css/sensaura.css"  media="screen,projection"/>
  </head>
  <body>
    <script type="text/javascript" src="js/jquery.js"></script>
    <script type="text/javascript" src="js/jqueryjson.js"></script>
    <script type="text/javascript">
      // The websocket connection (null if not available)
      var ws = null;
      var seq = 0;
      var pending = { };
      var serverOK = false;

      function recv(data) {
        console.log("Received data (RPC or WS)");
        }

      function rpcResponse(data) {
        console.log("Got response via RPC");
        }

      function rpcFailure(xhr, message, exception) {
        $("#server-message").text("Connection failure - " + message);
        $("#server-message").slideDown();
        }

      function send(type, target, data, onComplete) {
        // Build up the actual object to send
        var value = { type: type };
        if (type == "request") {
          value['method'] = target;
          value['sequence'] = seq;
          value['arguments'] = data;
          pending[seq] = onComplete;
          seq = seq + 1;
          }
        else if (type == "message") {
          value['topic'] = target;
          value['payload'] = data;
          }
        // Now send it off
        if (ws != null)
          ws.send($.toJSON(value));
        else {
          $.ajax({
            type: "POST",
            url: "/api/",
            error: rpcFailure,
            data: $.toJSON([ value ]),
            success: rpcResponse,
            dataType: "json",
            contentType: "application/json"
            });
          }
        }

      function message(topic, body, onComplete) {
        send("message", topic, body, onComplete);
        }

      function rpcCall(method, args, onComplete) {
        send("request", method, args, onComplete);
        }

      $(document).ready(
        function() {
          if ("WebSocket" in window) {
            var wsURL = "ws://" + location.hostname + (location.port ? ':' + location.port : ' ') + "/api/";
            var connection = new WebSocket(wsURL, [ 'rpc' ]);
            connection.onopen = function() {
              ws = connection;
              $("#server-message").text("Connection established");
              $("#server-message").slideDown();
              }
            connection.onerror = function(error) {
              // Fall back to polling
              rpcCall("poll", { }, function(result) { serverOK = true; });
              }
            }
          else {
            // Fall back to polling
            rpcCall("poll", { }, function(result) { serverOK = true; });
            }
          }
        );
    </script>
    <div id="server-message" class="hidden">
      Text
    </div>
  </body>
</html>

